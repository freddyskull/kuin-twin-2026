// apps/api/prisma/schema.prisma
generator client {
  provider        = "prisma-client-js" // Más compatible con NestJS
  previewFeatures = ["postgresqlExtensions"]
}

generator zod {
  provider = "zod-prisma-types"
  output   = "../../../libs/shared-types/src/zod"
}

datasource db {
  provider   = "postgresql"
  extensions = [postgis]
}

// --- IDENTIDAD ---

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String
  role      Role      @default(CUSTOMER)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  profile   Profile?
  services  Service[] // Si es Vendor
  bookings  Booking[] // Si es Customer
  media     Media[] // Galería de medios (WP style)

  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
}

model Message {
  id         String   @id @default(uuid())
  content    String
  senderId   String
  sender     User     @relation("SentMessages", fields: [senderId], references: [id])
  receiverId String
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
}

model Media {
  id        String   @id @default(uuid())
  url       String
  key       String? // Referencia para almacenamiento (S3, etc)
  fileName  String
  mimeType  String
  size      Int
  alt       String?
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

enum Role {
  ADMIN
  VENDOR
  CUSTOMER
}

model Profile {
  id          String  @id @default(uuid())
  userId      String  @unique
  user        User    @relation(fields: [userId], references: [id])
  displayName String
  bio         String?
  avatarUrl   String?

  // Localización para PostGIS
  // Usamos Unsupported para manejar el tipo nativo de PostGIS
  location        Unsupported("geography(Point, 4326)")?
  serviceRadiusKm Int                                    @default(10)

  ratingAvg     Decimal @default(0) @db.Decimal(3, 2)
  reviewsCount  Int     @default(0)
  businessHours Json? // Horarios generales en formato JSON
  isVerified    Boolean @default(false)

  portfolio PortfolioItem[]
}

model PortfolioItem {
  id                String   @id @default(uuid())
  profileId         String
  profile           Profile  @relation(fields: [profileId], references: [id])
  imageUrl          String
  description       String?
  imageGallery      String[] @default([])
  dynamicAttributes Json?
}

// --- CATÁLOGO ---

model Category {
  id          String     @id @default(uuid())
  name        String     @unique
  slug        String     @unique
  description String?
  imageUrl    String?
  isActive    Boolean    @default(true)
  parentId    String?
  parent      Category?  @relation("SubCategories", fields: [parentId], references: [id])
  children    Category[] @relation("SubCategories")
  services    Service[]
}

model ServiceUnit {
  id           String    @id @default(uuid())
  name         String    @unique // Ej: "Hora", "Metro Cuadrado"
  abbreviation String    @unique // Ej: "hr", "m2"
  services     Service[]
}

model Service {
  id         String      @id @default(uuid())
  vendorId   String
  vendor     User        @relation(fields: [vendorId], references: [id])
  categoryId String
  category   Category    @relation(fields: [categoryId], references: [id])
  unitId     String
  unit       ServiceUnit @relation(fields: [unitId], references: [id])

  title             String
  description       String?
  imageUrl          String?
  basePrice         Decimal @db.Decimal(10, 2)
  isActive          Boolean @default(true)
  dynamicAttributes Json? // Configuraciones adicionales

  metadata ServiceMetadata[]
  slots    ServiceSlot[]
  bookings Booking[]
}

model ServiceMetadata {
  id        String  @id @default(uuid())
  serviceId String
  service   Service @relation(fields: [serviceId], references: [id])
  key       String // Ej: "experiencia"
  value     String // Ej: "5 años"
}

// --- FLUJO DE RESERVAS ---

model Booking {
  id         String  @id @default(uuid())
  customerId String
  customer   User    @relation(fields: [customerId], references: [id])
  serviceId  String
  service    Service @relation(fields: [serviceId], references: [id])

  status        BookingStatus @default(PENDING)
  scheduledDate DateTime

  details BookingDetails?
  payment Payment?
  slots   ServiceSlot[] // Slots de tiempo bloqueados para esta reserva
}

enum BookingStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
}

model BookingDetails {
  id        String  @id @default(uuid())
  bookingId String  @unique
  booking   Booking @relation(fields: [bookingId], references: [id])

  serviceSnapshot Json // LA FOTO DEL SERVICIO AL COMPRAR
  unitPrice       Decimal @db.Decimal(10, 2)
  quantity        Int     @default(1)
  taxTotal        Decimal @db.Decimal(10, 2)
  grandTotal      Decimal @db.Decimal(10, 2)
}

model ServiceSlot {
  id        String   @id @default(uuid())
  serviceId String
  service   Service  @relation(fields: [serviceId], references: [id])
  bookingId String?
  booking   Booking? @relation(fields: [bookingId], references: [id])

  startTime   DateTime
  endTime     DateTime
  status      SlotStatus @default(AVAILABLE)
  isRecurring Boolean    @default(false)
}

enum SlotStatus {
  AVAILABLE
  BOOKED
  BLOCKED
}

model Payment {
  id          String  @id @default(uuid())
  bookingId   String  @unique
  booking     Booking @relation(fields: [bookingId], references: [id])
  amount      Decimal @db.Decimal(10, 2)
  processorId String // Stripe ID / MP ID
  status      String // p.ej: "succeeded", "pending"
}
